---
title: "ggpiestats"
author: "Indrajeet Patil"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    fig_width: 6
    fig.align: 'center'
    fig.asp: 0.618
    dpi: 300
    toc: true
    warning: FALSE
    message: FALSE
vignette: >
  %\VignetteIndexEntry{ggpiestats}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction to `ggpiestats`

The function `ggstatsplot::ggpiestats` can be used for quick **data
exploration** and/or to prepare **publication-ready pie charts** to summarize
the statistical relationship(s) amongst one or more categorical variables. We
will see examples of how to use this function in this vignette.

To begin with, here are some instances where you would want to use
`ggpiestats`-

 - to check if the proportion of observations matches our hypothesized
proportion, this is typically known as a "Goodness of Fit" test

 - to see if the frequency distribution of two categorical variables are
independent of each other using the contingency table analysis

 - to check if the proportion of observations at each level of a categorical
variable is equal

**Note before**: The following demo uses the pipe operator (`%>%`), if you are
not familiar with this operator, here is a good explanation:
<http://r4ds.had.co.nz/pipes.html>.

`ggpiestats` **only** works with data organized in dataframes or tibbles. It
will not work with other data structures like tables or matrices. It can operate
on dataframes that are organized with one row per observation or dataframes that
have one column containing counts. This vignette provides examples of both (see
examples below).

To help demonstrate how `ggpiestats` can be used with categorical or nominal
data a modified version of the original `Titanic` dataset that is included in
the `datasets` library has been provided in the `ggstatsplot` package with the
name `Titanic_full`. The Titanic Passenger Survival Dataset provides information
"on the fate of passengers on the fatal maiden voyage of the ocean liner
*Titanic*, including economic status(class), sex, age, and survival."

Let's have a look at the structure of both.

```{r titanic1, warning = FALSE, message = FALSE}
library(datasets)
library(dplyr)
library(ggstatsplot)

# looking at the original data in tabular format
dplyr::glimpse(x = Titanic)
# looking at the dataset as a tibble or dataframe
dplyr::glimpse(x = ggstatsplot::Titanic_full)
```

## Goodness of Fit with `ggpiestats`

The simplest use case for `ggpiestats` is that we want to display information
about **one** categorical or nominal variable. As part of that display or plot
we may also choose to execute a chi squared goodness of fit test to see whether
the proportions (or percentages) in categories of the single variable appear to
line up with our hypothesis or model. To keep very simple and then expand, let's
say that we'd like to display a piechart with the perecntages of passengers who
did or did not survive. Our initial hypothesis is that it was no different than
flipping a coin. People had a 50/50 chance of surviving.

```{r ggpiestats3, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 6}
ggstatsplot::ggpiestats(
  data = ggstatsplot::Titanic_full,                          
  main = Survived,
  title = "Passenger survival on the Titanic",       # title for the entire plot
  caption = "Source: Titanic survival dataset",      # caption for the entire plot
  legend.title = "Survived?",                        # legend title
  messages = FALSE
)
```

**Note:** equal proportions per category are the default eg 50/50, but you can
specify any hypothesized ratio you like with `ratio` so if our hypothesis was
that 80% died and 20% survived we would add `ratio = c(.80,.20)` when we entered
the code.

Let's move on to a more complex example statistically and interms of the
features we will use in `ggpiestats`

## Independence (or association) with `ggpiestats`

Let's next investigate whether the passenger's gender was indpeendent or
associated with gender. The test is whether the proportion of people who
survived was different between the sexes using `ggpiestats`.

We'll modify a number of arguments to change the appearance of this plot and
showcase the flexibility of `ggpiestats`. We will:


1. Change the plot theme to `ggplot2::theme_grey()` 2. Change our color palette
   to `category10_d3` from `ggsci` 3. We'll customize the subtitle by being more
   precise about which chi squared test this is `stat.title = "chi squared test of
   independence: "` 4. Finally, we'll make a call to `ggplot2` to modify the size
   of our plot title and to make it right justified

```{r ggpiestats1, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8}
# since effect size confidence intervals are computed using bootstrapping, let's
# set seed for reproducibility
set.seed(123)

ggstatsplot::ggpiestats(
  data = ggstatsplot::Titanic_full,
  main = Survived,
  condition = Sex,
  title = "Passenger survival on the Titanic by gender",       # title for the entire plot
  caption = "Source: Titanic survival dataset",                # caption for the entire plot
  legend.title = "Survived?",                                  # legend title
  ggtheme = ggplot2::theme_grey(),                             # changing plot theme 
  package = "ggsci",                                           # package from which color palette is to be taken
  palette = "category10_d3",                                   # choosing a different color palette
  stat.title = "chi squared test of independence: ",           # title for statistical test
  messages = FALSE
)  +                                                           # further modification with ggplot2 commands
  ggplot2::theme(plot.title = ggplot2::element_text(
    color = "black",
    size = 14,
    hjust = 1
  ))
```

The plot clearly shows that survival rates were very different between males and
females. The Pearson's chi-square test of independence is significant given our
large sample size. Additionally, for both females and males, the survival rates
were significantly different than 50% as indicated by the `***` which is
equivalent to a goodness of fit test for each gender.

## Grouped analysis with `grouped_ggpiestats`

What if we want to do the same analysis of gender but also factor in the
passenger's age (Age)? We have information that classifies the passengers as
Child or Adult, perhaps that makes a difference to their survival rate? We could
write a `for` loop or use `purrr`, but `ggstatsplot` provides a special helper
function for such instances: `grouped_ggpiestats`.

It is a convenient wrapper function around `ggstatsplot::combine_plots`. It
applies `ggpiestats` across all **levels** of a specified **grouping variable**
and then combines the list of individual plots into a single plot. Note that the
grouping variable can be anything: conditions in a given study, groups in a
study sample, different studies, etc.

```{r ggpiestats4, warning = FALSE, message = FALSE, fig.height = 10, fig.width = 8}
ggstatsplot::grouped_ggpiestats(
  # arguments relevant for ggstatsplot::gghistostats
  data = ggstatsplot::Titanic_full,
  grouping.var = Age,
  title.prefix = "Child or Adult?: ",
  stat.title = "chi squared test of independence: ",
  main = Survived,
  condition = Sex,
  messages = FALSE,
  # arguments relevant for ggstatsplot::combine_plots
  title.text = "Passenger survival on the Titanic by gender and age",
  caption.text = "Asterisks denote results from proportion tests; ***: p < 0.001, ns: non-significant",
  nrow = 2,
  ncol = 1
)
```

As seen from this quick exploratory analysis, across all passenger classes, the
proportion of survived to non-survived individuals differed across genders: Men
were more likely to perish than survive, whereas women were more likely to
survive than perish. The only exception was the 3rd Class passengers where women
were as likely to survive as to perish.

## Grouped analysis with `ggpiestats` + `purrr` 

Although this grouping function provides a quick way to explore the data, it
leaves much to be desired. For example, we may want to add different captions,
titles, themes, or palettes for each level of the grouping variable, etc. For
cases like these, it would be better to use `purrr` package. See the associated
vignette here:
<https://indrajeetpatil.github.io/ggstatsplot/articles/purrr_examples.html>

## Working with `counts` data

`ggpiestats` can also work with dataframe containing counts (aka tabled data),
i.e., when each row doesn't correspond to a unique observation. For example,
consider the following `fishing` dataframe containing data from two boats (`A`
and `B`) about the number of different types fish they caught in the months of
`February` and `March`. In this dataframe, each row doesn't equal a unique
observation. In such cases, we can use `counts` argument. Let's say we want to
investigate if the frequency of different types of fish caught differs across
the two months:

```{r ggpiestats7, message = FALSE, warning = FALSE, fig.height = 8, fig.width = 9}
# for reproducibility
set.seed(123)

# creating a dataframe
# (this is completely fictional; I don't know first thing about fishing!)
(
  fishing <- data.frame(
    Boat = c(rep("B", 4), rep("A", 4), rep("A", 4), rep("B", 4)),
    Month = c(rep("February", 2), rep("March", 2), rep("February", 2), rep("March", 2)),
    Fish = c(
      "Bass",
      "Catfish",
      "Cod",
      "Haddock",
      "Cod",
      "Haddock",
      "Bass",
      "Catfish",
      "Bass",
      "Catfish",
      "Cod",
      "Haddock",
      "Cod",
      "Haddock",
      "Bass",
      "Catfish"
    ),
    SumOfCaught = c(25, 20, 35, 40, 40, 25, 30, 42, 40, 30, 33, 26, 100, 30, 20, 20)
  ) %>% # converting to a tibble dataframe
    tibble::as_data_frame(x = .)
)

# running `ggpiestats` with counts information
ggstatsplot::ggpiestats(
  data = fishing,
  main = Fish,
  condition = Month,
  counts = SumOfCaught,
  package = "ggsci",
  palette = "default_jama",
  messages = FALSE
)

```

We just verified that the frequency of different types of fish caught differs
across the two months, but what if we further want to know if this difference is
present for both boats (since they are fishing in different parts of the sea)?
For this, we can again utilize `grouped_ggpiestats`:

## Within-subjects designs

In case of within-subjects designs, you can set `paired = TRUE`, which will
display results from McNemar test in the subtitle.

```{r ggpiestats9, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8}
# seed for reproducibility
set.seed(123)

# data
clinical_trial <- 
  tibble::tribble(
    ~Control,	~Case,	~pairs,
    "No",	"Yes",	25,
    "Yes",	"No",	4,
    "Yes",	"Yes",	13,
    "No",	"No",	92
  )

# plot
ggstatsplot::ggpiestats(data = clinical_trial,
                        condition = Control,
                        main = Case,
                        counts = pairs,
                        paired = TRUE,
                        stat.title = "McNemar test: ",
                        title = "Results from case-control study",
                        package = "ggsci",
                        palette = "default_ucscgb",
                        direction = -1,
                        messages = FALSE) 
```

# Suggestions

If you find any bugs or have any suggestions/remarks, please file an issue on
GitHub: <https://github.com/IndrajeetPatil/ggstatsplot/issues>

# Session Information

Summarizing session information for reproducibility.

```{r session_info}
options(width = 200)
devtools::session_info()
```

